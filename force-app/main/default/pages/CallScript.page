<apex:page controller="CallScriptController" standardStylesheets="false" showHeader="false" sidebar="true" >
    <html>
        <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.9/angular.min.js"></script>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous"/>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/css/bootstrap.min.css" rel="stylesheet"/>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/js/bootstrap.bundle.min.js"></script>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"/>
        <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js" integrity="sha384-IQsoLXl5PILFhosVNubq5LC7Qb9DXgDA9i+tQ8Zj3iwWAwPtgFTxbJ8NT4GN1R8p" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.min.js" integrity="sha384-cVKIPhGWiC2Al4u+LWgxfKTRIcfu0JTxR+EQDz/bgldoEyl4H0zUF0QKbrJ0EcQF" crossorigin="anonymous"></script>
        <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.13.0/css/all.min.css" rel="stylesheet"/>
        
        <style>
        
        html, body, #fullheight {
            min-height: 90% !important;
            height: 90%;
        }
        </style>

<script>
    var app = angular.module('myApp', []);
    app.controller('myCtrl', function($scope, $sce) {
        debugger;
        $scope.searchedKey='';
        $scope.allScripts;
        $scope.searchList = [];
        $scope.fileUrl;
        $scope.selectedFile;

        $scope.showIframe = false;
        
        CallScriptController.getScripts(function(res,event){
            console.log('Call Scripts-----',res);

            $scope.allScripts = res;
            $scope.searchList = res;

            $scope.$apply();
            console.log($scope.searchList.length);
        })

        $scope.searchHandler = function(event){
            debugger;
            console.log('Searched key ----',$scope.searchedKey);

            if($scope.searchedKey && $scope.searchedKey.length>0){
                CallScriptController.searchScriptsFilter($scope.searchedKey,function(res,event){
                    console.log('Searched Result---',res);

                    if(res && res.length>0){
                        $scope.searchList = res;
                    }else{
                        $scope.searchList = [];
                    }
                   // $scope.$apply();
                });
            }else{
                $scope.searchList = $scope.allScripts;
              //  $scope.$apply();
            }
        }

        $scope.getDocumetUrl = function(sFile){
            debugger;
            $scope.selectedFile = sFile;
            CallScriptController.getDocs(sFile.Id,function(res,evt){
                console.log('Res---',res);  
                //$scope.fileUrl = $sce.trustAsResourceUrl('https://whitemart--partial.sandbox.file.force.com/servlet/servlet.FileDownload?file='+res);
                $scope.fileUrl = $sce.trustAsResourceUrl('https://whitemart--partial.sandbox.my.salesforce-sites.com/servlet/servlet.FileDownload?file='+res);
                $scope.showIframe = true;
                $scope.$apply();
            })
        }

        $scope.backIv = function(){
            $scope.showIframe = false;

        }
    });
</script>
        <body ng-app="myApp" ng-controller="myCtrl" style="height: 100%;">
            <div id="fullheight">
                <div ng-show='!showIframe' >
                    <div class="input-group rounded">
                        <input type="search" ng-model="searchedKey" class="form-control rounded" placeholder="Search scripts" aria-label="Search" aria-describedby="search-addon" ng-change="searchHandler()"
                        />
                        <span class="input-group-text border-0" id="search-addon">
                            <i class="fas fa-search"></i>
                        </span>
                    </div>
                    <div style="border-style: solid;border-radius: 10px; margin-top: 10px;border-color: rgb(218, 218, 218);border-width: 1px">
                        <div ng-show="searchList && searchList.length>0" style="text-align: start;padding: 10px">
                            <div ng-repeat="item in searchList">
                                <h3 style="cursor: pointer;font-size: 20px;color: rgb(39, 39, 39)" ng-click="getDocumetUrl(item)">{{item.Name}}</h3>
                            </div>
                        </div>
                        <div ng-show="searchList && searchList.length==0" style="margin-top: 30px; text-align: center">
                            <h2>Scripts not found</h2>
                        </div>
                    </div>
                </div>

                <div id="fullheight" ng-show='showIframe' style="margin-top: 2%;height:100%;width:100%;" class="row">
                    <div style="width: 80%">
                        <button class="btn btn-primary " ng-click="backIv();">
                            <i class="fa fa-arrow-left" />
                        </button>
                        <h3 style="text-align: center;margin-top: -35px">{{selectedFile.Name}}</h3>
                    </div>
                    
                    <iframe id="myIframe" ng-src="{{fileUrl}}" style="width:100%;height:90%;"></iframe>
                </div>

            </div>
        </body>

    </html>
</apex:page>